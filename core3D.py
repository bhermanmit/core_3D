#!/usr/bin/env python2

import numpy as np
from collections import OrderedDict
import random
import math
import sys

n_axial = int(sys.argv[1])

# Global data
hzp_density = 0.73986            # Highest density
low_density = 0.66               # Lowest density
hzp_fueltemp = 600.0             # Lowest fuel temp 
high_fueltemp = 1200.0           # Highest fuel temp
baf = 36.0070
taf = 401.767

# CMFD file string
cmfd_str ="""<?xml version="1.0" encoding="UTF-8"?>
<cmfd>

  <!-- This file auto-generated by beavrs.py  -->
  <mesh>
    <lower_left>-182.78094 -182.78094 {bot}</lower_left>
    <upper_right>182.78094 182.78094 {top}</upper_right>
    <dimension>17 17 {n_axial}</dimension>
    <albedo>0.0 0.0 0.0 0.0 0.0 0.0</albedo>
    <map>

    {accel_map}
 
    </map>
    <energy>0.0 0.625e-6 20.0</energy>
  </mesh>
  
  <thermal>

    <water_id> 2 </water_id>
    <water_dens> 0.739779017 </water_dens>
    <!-- water density consistent with previous case -->

    <enr_map>

 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0 
 0.0  0.0  0.0  0.0  0.0  3.1  3.1  3.1  3.1  3.1  3.1  3.1  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  3.1  3.1  3.1  1.6  3.1  1.6  3.1  1.6  3.1  3.1  3.1  0.0  0.0  0.0
 0.0  0.0  3.1  3.1  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  3.1  3.1  0.0  0.0
 0.0  0.0  3.1  2.4  2.4  2.4  1.6  2.4  1.6  2.4  1.6  2.4  2.4  2.4  3.1  0.0  0.0
 0.0  3.1  3.1  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  3.1  3.1  0.0
 0.0  3.1  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  3.1  0.0
 0.0  3.1  3.1  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  3.1  3.1  0.0
 0.0  3.1  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  3.1  0.0
 0.0  3.1  3.1  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  3.1  3.1  0.0
 0.0  3.1  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  3.1  0.0
 0.0  3.1  3.1  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  3.1  3.1  0.0
 0.0  0.0  3.1  2.4  2.4  2.4  1.6  2.4  1.6  2.4  1.6  2.4  2.4  2.4  3.1  0.0  0.0
 0.0  0.0  3.1  3.1  2.4  1.6  2.4  1.6  2.4  1.6  2.4  1.6  2.4  3.1  3.1  0.0  0.0
 0.0  0.0  0.0  3.1  3.1  3.1  1.6  3.1  1.6  3.1  1.6  3.1  3.1  3.1  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  3.1  3.1  3.1  3.1  3.1  3.1  3.1  0.0  0.0  0.0  0.0  0.0
 0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0

    </enr_map>

    <bp_map>

   0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0 
   0    0    0    0    0    0    6    0    6    0    6    0    0    0    0    0    0
   0    0    0    0    0   16    0   20    0   20    0   16    0    0    0    0    0
   0    0    0   15   16    0   16    0   16    0   16    0   16   15    0    0    0
   0    0    0   16    0   16    0   12    0   12    0   16    0   16    0    0    0
   0    0   16    0   16    0   12    0   12    0   12    0   16    0   16    0    0
   0    6    0   16    0   12    0   12    0   12    0   12    0   16    0    6    0
   0    0   20    0   12    0   12    0   16    0   12    0   12    0   20    0    0
   0    6    0   16    0   12    0   16    0   16    0   12    0   16    0    6    0
   0    0   20    0   12    0   12    0   16    0   12    0   12    0   20    0    0
   0    6    0   16    0   12    0   12    0   12    0   12    0   16    0    6    0
   0    0   16    0   16    0   12    0   12    0   12    0   16    0   16    0    0
   0    0    0   16    0   16    0   12    0   12    0   16    0   16    0    0    0
   0    0    0   15   16    0   16    0   16    0   16    0   16   15    0    0    0
   0    0    0    0    0   16    0   20    0   20    0   16    0    0    0    0    0
   0    0    0    0    0    0    6    0    6    0    6    0    0    0    0    0    0
   0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0    0

    </bp_map>

    <fuel_temp>
{fuel_temp}
    </fuel_temp>

    <density>
{density}
    </density>

    <core_power> 3411e6 </core_power>
    <core_flowrate> 17083.3 </core_flowrate>
    <inlet_enthalpy> 1301740.0 </inlet_enthalpy>
    <n_assemblies> 193 </n_assemblies>
    <boron> 975 </boron>
    <maxthinner> 30 </maxthinner>
    <maxthouter> 1 </maxthouter>
    <run_thermal> 10 20 30 40 50 60 70 80 90 100 110 120 130 140 </run_thermal>
    <mc_feed_only> false </mc_feed_only>
  </thermal>

  <begin> 5 </begin>
  <tally_reset> 2 </tally_reset>
  <feedback> true </feedback>
  <norm> 193 </norm>
  <downscatter> true </downscatter>
  <estimator> tracklength </estimator>
  <n_save> 15 </n_save>
</cmfd>"""

# Acceleration map
accel = """
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 2 2 2 2 2 2 2 1 1 1 1 1
      1 1 1 2 2 2 2 2 2 2 2 2 2 2 1 1 1
      1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 1 1
      1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 1 1
      1 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 1
      1 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 1
      1 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 1
      1 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 1
      1 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 1
      1 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 1
      1 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 1
      1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 1 1
      1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 1 1
      1 1 1 2 2 2 2 2 2 2 2 2 2 2 1 1 1
      1 1 1 1 1 2 2 2 2 2 2 2 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
"""
no_accel="""
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
"""

# Density map
density = """
0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.7397790170.739779017 
0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 {0} {1} {2} {3} {4} {5} {6} 0.739779017 0.739779017 0.739779017 0.7397790170.739779017 
0.739779017 0.739779017 0.739779017 {7} {8} {9} {10} {11} {12} {13} {14} {15} {16} {17} 0.739779017 0.7397790170.739779017 
0.739779017 0.739779017 {18} {19} {20} {21} {22} {23} {24} {25} {26} {27} {28} {29} {30} 0.7397790170.739779017 
0.739779017 0.739779017 {31} {32} {33} {34} {35} {36} {37} {38} {39} {40} {41} {42} {43} 0.7397790170.739779017 
0.739779017 {44} {45} {46} {47} {48} {49} {50} {51} {52} {53} {54} {55} {56} {57} {58}0.739779017 
0.739779017 {59} {60} {61} {62} {63} {64} {65} {66} {67} {68} {69} {70} {71} {72} {73}0.739779017 
0.739779017 {74} {75} {76} {77} {78} {79} {80} {81} {82} {83} {84} {85} {86} {87} {88}0.739779017 
0.739779017 {89} {90} {91} {92} {93} {94} {95} {96} {97} {98} {99} {100} {101} {102} {103}0.739779017 
0.739779017 {104} {105} {106} {107} {108} {109} {110} {111} {112} {113} {114} {115} {116} {117} {118}0.739779017 
0.739779017 {119} {120} {121} {122} {123} {124} {125} {126} {127} {128} {129} {130} {131} {132} {133}0.739779017 
0.739779017 {134} {135} {136} {137} {138} {139} {140} {141} {142} {143} {144} {145} {146} {147} {148}0.739779017 
0.739779017 0.739779017 {149} {150} {151} {152} {153} {154} {155} {156} {157} {158} {159} {160} {161} 0.7397790170.739779017 
0.739779017 0.739779017 {162} {163} {164} {165} {166} {167} {168} {169} {170} {171} {172} {173} {174} 0.7397790170.739779017 
0.739779017 0.739779017 0.739779017 {175} {176} {177} {178} {179} {180} {181} {182} {183} {184} {185} 0.739779017 0.7397790170.739779017 
0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 {186} {187} {188} {189} {190} {191} {192} 0.739779017 0.739779017 0.739779017 0.7397790170.739779017 
0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.739779017 0.7397790170.739779017 
"""

# Fuel temp map
fuel_temp = """
900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0
900.0 900.0 900.0 900.0 900.0 {0} {1} {2} {3} {4} {5} {6} 900.0 900.0 900.0 900.0 900.0
900.0 900.0 900.0 {7} {8} {9} {10} {11} {12} {13} {14} {15} {16} {17} 900.0 900.0 900.0
900.0 900.0 {18} {19} {20} {21} {22} {23} {24} {25} {26} {27} {28} {29} {30} 900.0 900.0
900.0 900.0 {31} {32} {33} {34} {35} {36} {37} {38} {39} {40} {41} {42} {43} 900.0 900.0
900.0 {44} {45} {46} {47} {48} {49} {50} {51} {52} {53} {54} {55} {56} {57} {58} 900.0
900.0 {59} {60} {61} {62} {63} {64} {65} {66} {67} {68} {69} {70} {71} {72} {73} 900.0
900.0 {74} {75} {76} {77} {78} {79} {80} {81} {82} {83} {84} {85} {86} {87} {88} 900.0
900.0 {89} {90} {91} {92} {93} {94} {95} {96} {97} {98} {99} {100} {101} {102} {103} 900.0
900.0 {104} {105} {106} {107} {108} {109} {110} {111} {112} {113} {114} {115} {116} {117} {118} 900.0
900.0 {119} {120} {121} {122} {123} {124} {125} {126} {127} {128} {129} {130} {131} {132} {133} 900.0
900.0 {134} {135} {136} {137} {138} {139} {140} {141} {142} {143} {144} {145} {146} {147} {148} 900.0
900.0 900.0 {149} {150} {151} {152} {153} {154} {155} {156} {157} {158} {159} {160} {161} 900.0 900.0
900.0 900.0 {162} {163} {164} {165} {166} {167} {168} {169} {170} {171} {172} {173} {174} 900.0 900.0
900.0 900.0 900.0 {175} {176} {177} {178} {179} {180} {181} {182} {183} {184} {185} 900.0 900.0 900.0
900.0 900.0 900.0 900.0 900.0 {186} {187} {188} {189} {190} {191} {192} 900.0 900.0 900.0 900.0 900.0
900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0 900.0
"""

# produce strings
accel_str = ""
dens_str = ""
fuel_temp_str = ""
random.seed(974357)
for i in range(n_axial+2):

    if (i == 0 or i == n_axial+1):

        # CMFD Acceleration map
        accel_str += no_accel

        # Density map
        tmp = []
        for i in range(193):
            tmp.append(0.739779017)
        dens_str += density.format(*tmp)

        # Density map
        tmp = []
        for i in range(193):
            tmp.append(900.0)
        fuel_temp_str += fuel_temp.format(*tmp)

    else:

        # CMFD Acceleration map
        accel_str += accel

        # Density map
        tmp = []
        for i in range(193):
            tmp.append(random.uniform(low_density, hzp_density))
        dens_str += density.format(*tmp)

        # Density map
        tmp = []
        for i in range(193):
            tmp.append(random.uniform(hzp_fueltemp, high_fueltemp))
        fuel_temp_str += fuel_temp.format(*tmp)

dz = (taf - baf)/float(n_axial)
top = taf + dz
bot = baf - dz

with open('cmfd.xml','w') as fh:
    fh.write(cmfd_str.format(bot=bot, top=top, n_axial=n_axial+2, accel_map = accel_str, fuel_temp=fuel_temp_str, density=dens_str))
